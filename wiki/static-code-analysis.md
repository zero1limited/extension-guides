# Static Code Analysis / PHPStan

[TOC]


Initial brain dump on adding PHPStan to a project.
In this scenario I was using to try and determine how many errors a PHP upgrade was going to install.

1. Roll up instance
2. install phpstan: `composer require --dev phpstan/phpstan`
3. create an initial config file
    phpstan.neon`
    ```neon    
    parameters:
        level: 0
        paths:
            - app
            - extensions
            - vendor/akeneo
            - vendor/amasty
            - vendor/astock
            - vendor/cybersource
            - vendor/kiwicommerce
            - vendor/klarna
            - vendor/klaviyo
            - vendor/logicspot
            - vendor/loqate
            - vendor/mage_delight
            - vendor/mageworx
            - vendor/magmodules
            - vendor/zero1
            - vendor/zero1limited
        excludePaths:
            - vendor/*/*/Test/*
            - /*/*/Test/*
            - /*/Test/*
            - vendor/astock/stock-api-libphp/libs/phpcs-psr2-stock/*
            - vendor/akeneo/api-php-client/spec/*
        parallel:
            maximumNumberOfProcesses: 1
    ```
    In this case I just hand balled a few vendor paths in, we don't really want to test magento as we'd likely be upgrading that, but knowing about issues in third party modules should indicate that wee need to upgrade the module at the very least.
4. Generate a baseline `./vendor/bin/phpstan analyse -c phpstan.neon --generate-baseline`
    This will capture (most of) the current errors, as in this case we only care about new ones generated by the php upgrade
    this will generate: `phpstan-baseline.neon`
5. Include the base line in `phpstan.neon`, add the following to the top of the file
   ```neon
   includes:
    - phpstan-baseline.neon
   ```
6. Generate output: `./vendor/bin/phpstan analyse -c phpstan.neon > phpstan-PHP_VERSION.txt`
    (replacing PHP_VERSION with the current php version)
7. change PHP version in MDOQ and sync
8. re-require phpstan (to get the latest version for this version of PHP) `composer require --dev phpstan/phpstan`
9. Re-generate output: `./vendor/bin/phpstan analyse -c phpstan.neon > phpstan-PHP_VERSION.txt`
    (replacing PHP_VERSION with the current php version)
10. compare the output files, new errors are the ones we want.
