# Hyvä

[TOC]

Some bumf for Arron to write about our commitment to Hyvä, ethos, giving back, working with Vendic etc

## Types of Hyvä builds

### Switching to Hyvä Commerce

1. sort licensing out

Manually doing it using our Gitlab route - for demo's only
https://docs.hyva.io/hyva-commerce/getting-started/index.html


Gitlab Key for downloading packages - KEEP SAFE
```
        echo "-----BEGIN OPENSSH PRIVATE KEY-----
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
-----END OPENSSH PRIVATE KEY-----" > /home/magento/.ssh/id_rsa
            chown -R magento:magento /home/magento/.ssh
            chmod 400 /home/magento/.ssh/id_rsa
```


### Miami

Merchants can get up and running on Hyvä super fast if they use our base theme "Miami"

Miami comes with a lot of features and improvements to base Hyvä. For full details on Miami, [visit the Miami repo](https://github.com/zero1limited/Zero1_MiamiTheme)

### Retrofit

A retrofit project is where we build a Hyvä site for a customer which looks and feels the same as their current live site

Doing a retrofit will give clear results on the impact of Hyvä alone, as there's no difference to UX

### Custom build

We would generally advise against this and go for the simpler Miami build, purely because, the more complex a build is, the more complex it is to maintain and work on

## Installing Hyvä

### Base installation

[https://docs.hyva.io/hyva-themes/getting-started/index.html#getting-started](https://docs.hyva.io/hyva-themes/getting-started/index.html#getting-started)

Once a customer purchases Hyvä, they will receieve an email from Willem / Hyvä which contains full instructions on how to install it. It will look something like...

```
composer config --auth http-basic.hyva-themes.repo.packagist.com token 123456abcdef
composer config repositories.private-packagist composer https://hyva-themes.repo.packagist.com/your-url.co.uk/
composer require hyva-themes/magento2-default-theme
composer require hyva-themes/magento2-hyva-widgets
bin/magento set:up && bin/magento ca:fl
```

### Turn off minification

```
bin/magento -l config:set customer/captcha/enable 0
bin/magento -l config:set dev/template/minify_html 0
bin/magento -l  config:set dev/js/merge_files 0
bin/magento -l  config:set dev/js/enable_js_bundling 0
bin/magento -l  config:set dev/js/minify_files 0
bin/magento -l  config:set dev/js/move_script_to_bottom 0
bin/magento -l  config:set dev/css/merge_css_files 0
bin/magento -l  config:set dev/css/minify_files 0
```

### Install Miami and ElasticSuite (if required)

For all instructions on how to install Miami + ElasticSuite, [visit this repo](https://github.com/zero1limited/Zero1_MiamiTheme)

## MDOQ + Hyvä

Here are some key notes on what you need to do to get an MDOQ instance ready for a Hyvä build...

- Add the following to ```/mdoq/post_roll_up_actions```

```
blah blah blah
```

- Add the following to ```.gitignore```

```
################
# Hyvä on MDOQ #
################
app/design/frontend/*/*/web/tailwind/node_modules
app/design/frontend/*/*/web/css/styles.css
app/design/frontend/*/*/web/tailwind/tailwind-output.css
```

- Is node a thing we need to be worried about??
http://docs.mdoq.io/tutorials/mdoq/installing-npm-on-instances

## Hyvä Themes

All details for how to create a child theme of Hyvä are [in the Hyvä docs](https://docs.hyva.io/hyva-themes/building-your-theme/index.html)

However, we have created our own base theme [Miami](https://github.com/zero1limited/Zero1_MiamiTheme). This is for new customers that want to get started quick, and also a great base for retrofit projects as it contains continuous updates

Don't forget, the simpler the build, the simpler the maintenance and upgrades

We have also got a bunch of frontend [code snippets / tips in this repo](https://github.com/zero1limited/hyva-dev-tools/blob/master/FRONTEND-HYVA.md)


## Deferred Optimisation for 3rd party stuff
The below shows an example of loading Klaviyo's main script, put the following into the theme override
Klaviyo_Reclaim/templates/analytics/initialise.phtml

```
<?php $klaviyoKey = $this->getPublicApiKey(); ?>
<?php if ( $this->isKlaviyoEnabled() && $klaviyoKey ): ?>
<script type="application/javascript">
window.addEventListener('init-external-scripts', () => {
   const script = document.createElement('script')
   script.src = 'https://static.klaviyo.com/onsite/js/klaviyo.js?company_id=<?= $block->escapeHtml($klaviyoKey); ?>';
   script.type = 'application/javascript';
   document.head.append(script);
}, {once: true, passive: true});
</script>
<?php endif; ?>
```

## Hyvä Checkout

For anything relating to Hyvä Checkout, [visit this repo](https://github.com/zero1limited/hyva-checkout/tree/master)

## Luma Checkout (fallback from Hyvä)

Some client's may be using Hyvä, but aren't yet on Hyvä Checkout. If this is the case, we can simply fall back to their current checkout (which will be based off Luma)

If the client is a new client, but doesn't want to go to Hyvä Checkout, [here's a base theme install for a basic Luma checkout](https://github.com/zero1limited/luma-checkout-for-hyva/tree/master)

## ZERO-1 Hyvä Modules

### Sub Category Listing - Needs work - Sean TODO!

```composer require zero1/module-sub-category-listing```

Add the following code to catalog_category_view.xml...

```
<head>
    <remove src="Zero1_SubCategoryListing::css/subcategorylisting.css" />
</head>
```

Pill shaped Sub Category Listing...

Add this to your theme - your/theme/Zero1_SubCategoryListing/templates/sub-category-listing.phtml

```
<?php
/** @var \Zero1\SubCategoryListing\Block\View $block */
?>
<?php if ($block->showSubCategoryListing()) : ?>
    <div class="sub-category-listing text-left mt-6">
		<ul>
			<?php foreach ($block->getCurrentCategoryChildren() as $currentCategoryChild) : ?>
		    	<li class="inline-flex mb-4">
		            <a class="border border-c-primary-cta bg-c-highlight px-6 md:px-4 py-3 md:py-1 font-bold text-center c-rounded mr-2" href="<?php echo $block->escapeUrl($currentCategoryChild->getUrl()); ?>"><?php echo $block->escapeHtml($currentCategoryChild->getName()); ?></a>
		        </li>
			<?php endforeach; ?>
		</ul>
    </div>
<?php endif; ?>
```

Then add this to your css...

```
@media screen and (max-width: 640px) {
    .sub-category-listing {overflow-x: auto;width: 100%;margin-right: auto;margin-left: auto;max-width: 1380px;}
    .sub-category-listing ul {width: -webkit-max-content;width: -moz-max-content;width: max-content;margin-bottom: 1rem;}
}
```

### Price High to Low / Low to High on PLP Toolbar

There's a module which does this using a plugin. You'll need to change one .phtml file (if required)

Here's the link to the [Zero1_SortByPrice module](https://github.com/zero1limited/SortByPrice).

### Splats - Needs work - Sean TODO!

Zero1 module which shows product discounts and "New" products on PLP and PDP. Couple of frontend changes required but it's [all documented in this repo](https://github.com/zero1limited/Splats/tree/master)

## QA Processes

[Ghost Inspector Master Suite for Hyvä](https://app.ghostinspector.com/suites/63c03119af1e488d25126caf)

Trigger the above suite with a specific Start URL
https://api.ghostinspector.com/v1/suites/63c03119af1e488d25126caf/execute/?apiKey=5ea993e7ab90be6bdeb7b0397904273e68b3b43d&startUrl=https://www-worldofpower-co-uk-16151.02.mdoq.io/

## Troubleshooting Hyvä

Here is a list of potential issues / solutions

### npm - command not found

Run the following in root...

```
curl -o - https://raw.githubusercontent.com/creationix/nvm/v0.34.0/install.sh | bash \
&& export NVM_DIR="$HOME/.nvm" \
&& [ -s "$NVM_DIR/nvm.sh" ] \
&& \. "$NVM_DIR/nvm.sh" \
&& [ -s "$NVM_DIR/bash_completion" ] \
&& \. "$NVM_DIR/bash_completion" \
&& nvm install 12.20.1 \
&& nvm use 12.20.1 \
&& npm install --global gulp-cli \
&& npm install --global yarn
```

### command not found: postcss

Got the above error after running `npm run build-dev`
Fix is to run `npm install -D postcss`
Then re-run `npm run build-dev`


## Common Errors

### Compilation from source FILENAME failed
This error can occur if either 'setup:upgrade' has not been ran BEFORE static content deployment, or the steps above for 'Turn off minification'

## Checkout CSP

The very latest versions of Hyva checkout enforce strict CSP. This will likely cause issues unless all scripts including inline scripts are properly included / written using new methods.
The latest version of Hyva checkout to not enforce CSP strict mode is `1.1.29`.

There is an identified issue where having the Hyvä Fallback module enabled with a `checkout/index` set as a fallback kills the checkout once advanced
to the payment method and beyond and refreshing/reloading the page, as the `$hyvaCsp` value is not accessible within the Hyvä templates. This may also
be why some sites experience a loss of styles on a refreshing of the page. The recommended solution is to remove the fallback module if the site is 100% hyvä,
or to remove the `checkout/index` fallback url from within the fallback module's configs

Note there is also a `1.1.29csp` version, don't install this if you don't want forced CSP strict mode.

At this time if you would like to install `1.1.29`, run: `composer require hyva-themes/magento2-hyva-checkout:1.1.29`, then run setup upgrade etc.
